name: Clang-Tidy

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    runs-on: ubuntu-latest
    name: Clang-Tidy Analysis

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-tidy-17 cmake

      - name: Configure (generate compile_commands.json)
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
            -DCMAKE_CXX_COMPILER=clang++-17

      - name: Run clang-tidy on dispatcher
        run: |
          clang-tidy-17 \
            -p build \
            --header-filter='include/dev/.*' \
            --warnings-as-errors='*' \
            --checks='-*,\
              bugprone-*,\
              clang-analyzer-*,\
              cppcoreguidelines-*,\
              misc-*,\
              modernize-*,\
              performance-*,\
              readability-*,\
              -modernize-use-trailing-return-type,\
              -readability-identifier-length,\
              -cppcoreguidelines-avoid-magic-numbers,\
              -readability-magic-numbers' \
            src/main.cpp

      - name: Run clang-tidy on plugins
        run: |
          for f in examples/*.cpp; do
            echo "=== Linting $f ==="
            clang-tidy-17 \
              -p build \
              --checks='-*,\
                bugprone-*,\
                clang-analyzer-*,\
                performance-*,\
                readability-braces-around-statements,\
                modernize-use-nullptr' \
              "$f" || true
          done
